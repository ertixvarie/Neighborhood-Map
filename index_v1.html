<!DOCTYPE html>
<html>
  <head>
    <meta charset="uts-8">
    <link rel="stylesheet" href="css/style.css">

  </head>
  <body>
    <h3>My Google Maps Demo</h3>
    <style>
    #map {
      height: 100%;
    }
      html,
      body {
        font-family: Arial, sans-serif;
        height: 100%;
        margin: 0;
        padding: 0;
      }

      .options-box {
        background: #fff;
        border: 1px solid #999;
        border-radius: 3px;
        height: 100%;
        line-height: 35px;
        padding: 10px 10px 30px 10px;
        text-align: left;
        width: 340px;
      }
    </style>
    <div id="filter">

    </div>

    <div id="app"></div>
    <div class="options-box">
      <input id="show-listing" type="button" value="Show Listings">
      <input id="hide-listing" type="button" value="Hide Listings">
    </div>

    <div id="map"></div>
    <script>
    var map;

      function initMap() {
        var styles = [
        {
          featureType: 'water',
          stylers: [{color: '#19a0d8'}]
        }
        ];

        var locations = [
        {title: 'House of Tai Pei', location: {lat: 35.4404048, lng: -80.8740417}, address: '1'},
        {title: 'Wan-Fu Quality Chinese Cuisine', location: {lat: 35.0886242, lng: -80.863675}, address: '2'},
        {title: 'Soho Bistro', location: {lat: 35.2275837, lng: -80.9104183}, address: '3'},
        {title: 'Shun Lee Palace', location: {lat: 35.1774188, lng: -80.8687371}, address: '4'},
        {title: 'Baoding Restuarant', location: {lat: 35.1474744, lng: -80.9029179}, address: '5'}
        ];

        var CLIENT_ID = "CEYUGBQFIGLCH40JGX3WCRRLQN54TYF2FRCW2KPBANYGECV0"
        var CLIENT_SECRET = "OX2LVD1ENKIZ0YX0QGFPVFYNZMCNI4G3E0UXNDOOYWEKKQOJ"

//        var foursquareResults = "https://api.foursquare.com/v2/venues/search?ll=35.4404048,-80.8740417"+"&client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&query="+title+"&v=20170801&m=foursquare&limit=1";

          map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: {lat: 35.2270869, lng: -80.8431267},
          styles: styles,
          mapTypeControl: false
          });

          var markers = [];
          var infowindow = new google.maps.InfoWindow();
          var defaultIcon = colorMarkers('0091ff');
          var highlightedIcon = colorMarkers('FFFF24');
          var locationObject = "";

          getAddresses();

          document.getElementById('show-listing').addEventListener('click', showListings);
          document.getElementById('hide-listing').addEventListener('click', hideListings);
//Access foursquare API for address async

          function getAddresses(){
            var promises = [];
            return Promise.resolve(promises)
            .then(function(value){

            locations.forEach(function(object) {
              var position = object.location;
              var title = object.title;
              var foursquareResults = "https://api.foursquare.com/v2/venues/search?ll="+position.lat+","+position.lng+"&client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&query="+title+"&v=20170801&m=foursquare&limit=1";
              var getPromise = fetch(foursquareResults)
                .then(function(response) { return response.json();})
                  .then(function(data) {
                    object.address = data.response.venues[0].location.formattedAddress[0];

                      var marker = new google.maps.Marker({
                      map: map,
                      position: object.location,
                      address: object.address,
                      title: object.title,
                      icon: defaultIcon,
                      animation: google.maps.Animation.DROP,
                      })

                      markers.push(marker);

                      marker.addListener('click', function() {
                        populateInfoWindow(this, infowindow);
                      });
                  })
                    .then(function() {
                      promises.push(getPromise);
                    })
            });
            return Promise.all(promises);
            });
          }

          function showListings() {
            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(map);
              bounds.extend(markers[i].position);
            }
            map.fitBounds(bounds);
          }
          function populateInfoWindow(marker, infowindow) {
            if (infowindow.marker !=marker) {
              infowindow.marker = marker;
              infowindow.setContent('<div>'+marker.title+'</div>'+'<div>'+marker.address+'</div');
              infowindow.open(map, marker);
              infowindow.addListener('closeclick', function() {
                infowindow.setMarker = null;
              });
            }
          }

          function hideListings() {
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(null);
            }
          }
          function colorMarkers(color) {
            var markerImage = new google.maps.MarkerImage(
              'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+color+'|40|_|%E2%80%A2',
              new google.maps.Size(21, 34),
              new google.maps.Point(0, 0),
              new google.maps.Point(10,34),
              new google.maps.Size(21, 34));
          }
      }
    </script>

    <script src="js/knockout-3.4.2.js"></script>
    <script src="js/app.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmoYzRDSKh1EEKS9N8UHnB6h9sfDgdHck&v=3&callback=initMap">
    </script>
  </body>
</html>